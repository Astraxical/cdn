<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitFile Hosting - Store and Share Files</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #0d6efd;
        }
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .nav-tabs .nav-link {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-cloud-arrow-up"></i> GitFile Hosting
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-tab="upload">Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="git">Git Import</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="files">Files</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="shortener">Link Shortener</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">Upload Files</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="git-tab" data-bs-toggle="tab" data-bs-target="#git" type="button" role="tab">Git Import</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">My Files</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="shortener-tab" data-bs-toggle="tab" data-bs-target="#shortener" type="button" role="tab">Link Shortener</button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="mainTabContent">
                    <!-- Upload Tab -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-upload"></i> Upload Files</h5>
                                <div class="upload-area" id="uploadArea">
                                    <i class="bi bi-cloud-upload display-1 text-muted"></i>
                                    <p class="mt-3">Drag & drop files here or click to select</p>
                                    <input type="file" id="fileInput" class="d-none" multiple>
                                    <button class="btn btn-primary mt-2" id="browseBtn">Browse Files</button>
                                </div>
                                <div class="mt-3" id="uploadProgress" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <p class="text-center mt-2" id="progressText">Uploading...</p>
                                </div>
                                <div class="mt-3" id="uploadResult"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Git Import Tab -->
                    <div class="tab-pane fade" id="git" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-github"></i> Import from Git</h5>
                                <form id="gitImportForm">
                                    <div class="mb-3">
                                        <label for="repoUrl" class="form-label">Repository URL</label>
                                        <input type="url" class="form-control" id="repoUrl" placeholder="https://github.com/username/repo.git" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="branchName" class="form-label">Branch Name</label>
                                        <input type="text" class="form-control" id="branchName" value="main" required>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-download"></i> Import from Git
                                    </button>
                                </form>
                                <div class="mt-3" id="gitResult"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Files Tab -->
                    <div class="tab-pane fade" id="files" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-files"></i> My Files</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped" id="filesTable">
                                        <thead>
                                            <tr>
                                                <th>Filename</th>
                                                <th>Size</th>
                                                <th>Uploaded</th>
                                                <th>Source</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="filesList">
                                            <!-- Files will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Link Shortener Tab -->
                    <div class="tab-pane fade" id="shortener" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-link-45deg"></i> Link Shortener</h5>
                                <form id="shortenForm">
                                    <div class="mb-3">
                                        <label for="longUrl" class="form-label">Long URL</label>
                                        <input type="url" class="form-control" id="longUrl" placeholder="https://example.com/very/long/url" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send"></i> Shorten URL
                                    </button>
                                </form>
                                
                                <div class="mt-4" id="shortenResult" style="display: none;">
                                    <div class="alert alert-success">
                                        <strong>Shortened URL:</strong> <a href="#" id="shortUrlLink" target="_blank" class="fw-bold"></a>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" id="copyShortUrl">Copy</button>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h6>My Shortened Links</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm" id="linksTable">
                                            <thead>
                                                <tr>
                                                    <th>Short Code</th>
                                                    <th>Original URL</th>
                                                    <th>Created</th>
                                                    <th>Clicks</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="linksList">
                                                <!-- Links will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API base URL - in production, this would be your actual API endpoint
        const API_BASE_URL = window.location.origin;

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const uploadResult = document.getElementById('uploadResult');
        const gitImportForm = document.getElementById('gitImportForm');
        const gitResult = document.getElementById('gitResult');
        const filesList = document.getElementById('filesList');
        const shortenForm = document.getElementById('shortenForm');
        const shortenResult = document.getElementById('shortenResult');
        const shortUrlLink = document.getElementById('shortUrlLink');
        const copyShortUrl = document.getElementById('copyShortUrl');
        const linksList = document.getElementById('linksList');

        // Event Listeners
        browseBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        gitImportForm.addEventListener('submit', handleGitImport);
        shortenForm.addEventListener('submit', handleUrlShorten);

        copyShortUrl.addEventListener('click', copyShortUrlToClipboard);

        // Set up tab navigation
        document.querySelectorAll('[data-tab]').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const tabName = this.getAttribute('data-tab');
                // Find the corresponding tab button and click it
                document.querySelector(`[data-bs-target="#${tabName}"]`).click();
                
                // Load content based on the selected tab
                if(tabName === 'files') {
                    loadFilesList();
                } else if(tabName === 'shortener') {
                    loadLinksList();
                }
            });
        });

        // Functions
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#0d6efd';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#ccc';
            
            const files = e.dataTransfer.files;
            if (files.length) {
                uploadFiles(files);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length) {
                uploadFiles(e.target.files);
            }
        }

        function uploadFiles(files) {
            const formData = new FormData();
            
            for (let i = 0; i < files.length; i++) {
                formData.append('file', files[i]);
            }

            // Show progress bar
            document.getElementById('uploadProgress').style.display = 'block';
            
            fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('uploadProgress').style.display = 'none';
                
                if (data.error) {
                    uploadResult.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    uploadResult.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    fileInput.value = '';
                }
                
                // Reload files list
                loadFilesList();
            })
            .catch(error => {
                document.getElementById('uploadProgress').style.display = 'none';
                uploadResult.innerHTML = `<div class="alert alert-danger">Error uploading files: ${error.message}</div>`;
            });
        }

        function handleGitImport(e) {
            e.preventDefault();
            
            const repoUrl = document.getElementById('repoUrl').value;
            const branchName = document.getElementById('branchName').value;
            
            fetch(`${API_BASE_URL}/git/import`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    repo_url: repoUrl,
                    branch: branchName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    gitResult.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    gitResult.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    document.getElementById('gitImportForm').reset();
                }
                
                // Reload files list
                loadFilesList();
            })
            .catch(error => {
                gitResult.innerHTML = `<div class="alert alert-danger">Error importing from Git: ${error.message}</div>`;
            });
        }

        function handleUrlShorten(e) {
            e.preventDefault();
            
            const longUrl = document.getElementById('longUrl').value;
            
            fetch(`${API_BASE_URL}/shorten`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: longUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('shortenResult').style.display = 'none';
                    alert(`Error: ${data.error}`);
                } else {
                    document.getElementById('shortenResult').style.display = 'block';
                    shortUrlLink.href = data.short_url;
                    shortUrlLink.textContent = data.short_url;
                    document.getElementById('longUrl').value = '';
                }
                
                // Reload links list
                loadLinksList();
            })
            .catch(error => {
                document.getElementById('shortenResult').style.display = 'none';
                alert(`Error shortening URL: ${error.message}`);
            });
        }

        function copyShortUrlToClipboard() {
            const textArea = document.createElement('textarea');
            textArea.value = shortUrlLink.href;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Show feedback
            const originalText = copyShortUrl.textContent;
            copyShortUrl.textContent = 'Copied!';
            setTimeout(() => {
                copyShortUrl.textContent = originalText;
            }, 2000);
        }

        function loadFilesList() {
            fetch(`${API_BASE_URL}/files`)
            .then(response => response.json())
            .then(files => {
                filesList.innerHTML = '';
                
                if (files.length === 0) {
                    filesList.innerHTML = '<tr><td colspan="5" class="text-center">No files uploaded yet</td></tr>';
                    return;
                }
                
                files.forEach(file => {
                    const row = document.createElement('tr');
                    
                    // Format file size
                    const fileSize = formatFileSize(file.size);
                    
                    // Format date
                    const uploadDate = new Date(file.upload_date).toLocaleDateString();
                    
                    row.innerHTML = `
                        <td>${file.filename}</td>
                        <td>${fileSize}</td>
                        <td>${uploadDate}</td>
                        <td><span class="badge bg-${file.source === 'git' ? 'primary' : 'secondary'}">${file.source}</span></td>
                        <td>
                            <a href="${API_BASE_URL}/download/${file.file_id}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="bi bi-download"></i> Download
                            </a>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteFile('${file.file_id}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    
                    filesList.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading files list:', error);
                filesList.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading files</td></tr>';
            });
        }

        function loadLinksList() {
            fetch(`${API_BASE_URL}/links`)
            .then(response => response.json())
            .then(links => {
                linksList.innerHTML = '';
                
                if (links.length === 0) {
                    linksList.innerHTML = '<tr><td colspan="5" class="text-center">No shortened links yet</td></tr>';
                    return;
                }
                
                links.forEach(link => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const creationDate = new Date(link.created_at).toLocaleDateString();
                    
                    row.innerHTML = `
                        <td>${link.short_code}</td>
                        <td><a href="${link.original_url}" target="_blank">${truncateUrl(link.original_url)}</a></td>
                        <td>${creationDate}</td>
                        <td>${link.clicks}</td>
                        <td>
                            <a href="${API_BASE_URL}/s/${link.short_code}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="bi bi-box-arrow-up-right"></i> Visit
                            </a>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteLink('${link.short_code}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    
                    linksList.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading links list:', error);
                linksList.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading links</td></tr>';
            });
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`${API_BASE_URL}/delete/${fileId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error deleting file: ${data.error}`);
                    } else {
                        alert('File deleted successfully');
                        loadFilesList(); // Reload the files list
                    }
                })
                .catch(error => {
                    alert(`Error deleting file: ${error.message}`);
                });
            }
        }

        function deleteLink(shortCode) {
            if (confirm('Are you sure you want to delete this short link?')) {
                fetch(`${API_BASE_URL}/links/${shortCode}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error deleting link: ${data.error}`);
                    } else {
                        alert('Link deleted successfully');
                        loadLinksList(); // Reload the links list
                    }
                })
                .catch(error => {
                    alert(`Error deleting link: ${error.message}`);
                });
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function truncateUrl(url) {
            return url.length > 50 ? url.substring(0, 47) + '...' : url;
        }

        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load files list when the files tab is active
            const filesTabButton = document.getElementById('files-tab');
            filesTabButton.addEventListener('shown.bs.tab', function() {
                loadFilesList();
            });
            
            // Load links list when the shortener tab is active
            const shortenerTabButton = document.getElementById('shortener-tab');
            shortenerTabButton.addEventListener('shown.bs.tab', function() {
                loadLinksList();
            });
            
            // Load files list if on the files tab by default
            loadFilesList();
        });
    </script>
</body>
</html>